<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Vakilaw.Views.LawBankPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:Vakilaw.ViewModels"
    xmlns:models="clr-namespace:Vakilaw.Models"
    xmlns:conv="clr-namespace:Vakilaw.Converters"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"    
    FlowDirection="RightToLeft"
    BackgroundImageSource="bg_mainpage.jpg">

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:BoolToStarConverter x:Key="BoolToStarConverter" />
            <Style x:Key="CardFrameStyle" TargetType="Border">
                <Setter Property="StrokeShape" Value="12"/>
                <Setter Property="Padding" Value="10"/>
                <Setter Property="Margin" Value="6,8"/>
                <Setter Property="BackgroundColor" Value="White"/>
            </Style>
            <Color x:Key="Accent">#ffffff</Color>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Shell.TitleView>
        <Grid ColumnDefinitions="*,Auto" Padding="10">
            <Label Text="بانک قوانین حقوقی"
                   Margin="-10,0,0,0"
                   TextColor="White"
                   FontFamily="IRANSansWeb"
                   FontSize="16"
                   FontAttributes="Bold"/>
            <Picker Grid.Column="1"
                    Title="انتخاب نوع قانون"
                    FontAttributes="Bold"
                    FontSize="12"
                    FlowDirection="RightToLeft"
                    ItemsSource="{Binding LawTypes}"
                    SelectedItem="{Binding SelectedLawType, Mode=TwoWay}"/>
        </Grid>
    </Shell.TitleView>

    <Grid RowDefinitions="Auto,*,Auto" Padding="12">
        <Image Source="search3.png" HeightRequest="20" WidthRequest="20" HorizontalOptions="Start"/>
        <Entry Grid.Column="0" HorizontalTextAlignment="Center" Placeholder="جستجوی ماده ..." PlaceholderColor="DarkGray" Text="{Binding SearchText, Mode=TwoWay}" HorizontalOptions="Fill"/>
 
        <!-- CollectionView + ActivityIndicator -->
        <Grid Grid.Row="1">
            <CollectionView ItemsSource="{Binding Laws}"
                            SelectionMode="None"
                            Margin="0,6,0,6">
                           
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:LawItem">
                        <Border Style="{StaticResource CardFrameStyle}">
                            <toolkit:Expander IsExpanded="{Binding IsExpanded, Mode=TwoWay}">
                                <toolkit:Expander.Header>
                                    <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                                        <Label Text="{Binding Title}"
                                               FontSize="16"
                                               TextColor="Black"
                                               FontAttributes="Bold"
                                               VerticalOptions="Center"
                                               LineBreakMode="TailTruncation"/>
                                        <ImageButton Source="{Binding IsBookmarked, Converter={StaticResource BoolToStarConverter}}"
                                                     Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleBookmarkCommand}"
                                                     CommandParameter="{Binding .}"
                                                     BackgroundColor="Transparent"
                                                     WidthRequest="34"
                                                     HeightRequest="34"
                                                     Grid.Column="1"
                                                     HorizontalOptions="End"
                                                     VerticalOptions="Center"/>
                                    </Grid>
                                </toolkit:Expander.Header>

                                <toolkit:Expander.Content>
                                    <VerticalStackLayout Padding="0,8,0,0" Spacing="6">
                                        <Label Text="{Binding Text}"
                                               FontSize="14"
                                               TextColor="#333"
                                               LineBreakMode="WordWrap"/>
                                        <HorizontalStackLayout Spacing="10" HorizontalOptions="End">
                                            <Button Text="مشاهده جزئیات"
                                                    FlowDirection="RightToLeft"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.OpenArticleCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#003049"
                                                    TextColor="{StaticResource Accent}"/>
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>
                                </toolkit:Expander.Content>
                            </toolkit:Expander>

                            <Border.Triggers>
                                <DataTrigger TargetType="Border" Binding="{Binding IsExpanded}" Value="True">
                                    <Setter Property="BackgroundColor" Value="GhostWhite"/>
                                </DataTrigger>
                            </Border.Triggers>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

             <!--Loading overlay--> 
            <ActivityIndicator IsRunning="{Binding IsLoading}"
                               IsVisible="{Binding IsLoading}"
                               Color="{StaticResource Accent}"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>
        </Grid>

        <BoxView Grid.Row="2" HeightRequest="8" Color="Transparent"/>
    </Grid>
</ContentPage>